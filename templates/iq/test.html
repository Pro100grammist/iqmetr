<!-- templates/iq/test.html -->
{% extends "base.html" %}
{% block title %}Тест — iqmetr{% endblock %}
{% block content %}
  <h1>Тест</h1>
  <form method="post" id="test-form">{% csrf_token %}
    {% for q in questions %}
      <div class="question" data-qid="{{ q.id }}">
        <strong>#{{ forloop.counter }}.</strong> {{ q.text }}
        <div class="answers">
          {% for a in q.answers.all %}
            <label>
              <input type="radio" name="answer_{{ q.id }}" value="{{ a.id }}">
              {{ a.text }}
            </label>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
    <div style="display:flex; gap:10px; margin-top:16px;">
      <button class="btn" type="submit" name="finish_now" value="1">Завершити тест</button>
      <button class="btn secondary" type="submit">Зберегти проміжні відповіді</button>
    </div>
  </form>
  <p class="muted">Ви можете зберігати відповіді під час проходження. Після завершення результат буде підраховано.</p>
{% endblock %}
{% block scripts %}
<script>
  // Таймер
  let remaining = {{ remaining|default:0 }};
  const timerEl = document.getElementById('timer');
  const form = document.getElementById('test-form');

  function tick() {
    if (remaining <= 0) {
      // Автофініш
      const fin = document.createElement('input');
      fin.type = 'hidden';
      fin.name = 'finish_now';
      fin.value = '1';
      form.appendChild(fin);
      form.submit();
      return;
    }
    const m = Math.floor(remaining / 60).toString().padStart(2,'0');
    const s = (remaining % 60).toString().padStart(2,'0');
    timerEl.textContent = `${m}:${s}`;
    remaining--;
    setTimeout(tick, 1000);
  }
  tick();

  // Прогрес: лічимо скільки питань уже з відповіддю
  const total = {{ total_questions }};
  const inner = document.getElementById('progress-inner');
  const text = document.getElementById('progress-text');

  function updateProgress() {
    const answered = new Set();
    document.querySelectorAll('.question').forEach(q => {
      const qid = q.getAttribute('data-qid');
      const checked = q.querySelector('input[type=radio]:checked');
      if (checked) answered.add(qid);
    });
    const done = answered.size;
    const pct = Math.round((done / total) * 100);
    inner.style.width = pct + '%';
    text.textContent = `${done} / ${total}`;
  }

  document.querySelectorAll('input[type=radio]').forEach(i => {
    i.addEventListener('change', updateProgress);
  });
  updateProgress();
</script>
{% endblock %}
